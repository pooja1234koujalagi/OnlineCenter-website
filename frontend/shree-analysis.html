<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Upload Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .item-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .duplicate {
            border-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Shree Upload Analysis</h1>
        <p>Analyzing why 1 database upload shows as 2 in dashboard/profile</p>
        
        <div class="step">
            <h3>Step 1: Check Session</h3>
            <button class="btn" onclick="checkSession()">Check Session</button>
            <div id="sessionResult"></div>
        </div>
        
        <div class="step">
            <h3>Step 2: Get Raw API Data</h3>
            <button class="btn" onclick="getRawData()">Get Raw API Data</button>
            <div id="rawDataResult"></div>
        </div>
        
        <div class="step">
            <h3>Step 3: Analyze Each Item</h3>
            <button class="btn" onclick="analyzeItems()">Analyze Items</button>
            <div id="analysisResult"></div>
        </div>
        
        <div class="step">
            <h3>Step 4: Test Deduplication</h3>
            <button class="btn" onclick="testDeduplication()">Test Deduplication</button>
            <div id="deduplicationResult"></div>
        </div>
        
        <div class="step">
            <h3>Complete Debug Log</h3>
            <div id="debugLog" class="data-display">Debug log will appear here...</div>
            <button class="btn" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let debugData = {
            session: null,
            rawData: null,
            analysis: null
        };

        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function checkSession() {
            log('üîç Checking session...');
            fetch('/api/session', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    debugData.session = data;
                    log(`‚úÖ Session: ${JSON.stringify(data, null, 2)}`);
                    document.getElementById('sessionResult').innerHTML = 
                        `<div class="success">Logged in: ${data.loggedIn}, User: ${data.user?.name}, Role: ${data.user?.role}</div>`;
                })
                .catch(error => {
                    log(`‚ùå Session error: ${error.message}`);
                    document.getElementById('sessionResult').innerHTML = 
                        `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function getRawData() {
            log('üîç Getting raw API data...');
            fetch('/api/my-uploads', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    debugData.rawData = data;
                    log(`‚úÖ Raw API data received: ${data ? data.length : 0} items`);
                    log(`üìä Raw data: ${JSON.stringify(data, null, 2)}`);
                    
                    document.getElementById('rawDataResult').innerHTML = 
                        `<div class="success">Received ${data ? data.length : 0} items from API</div>`;
                })
                .catch(error => {
                    log(`‚ùå API error: ${error.message}`);
                    document.getElementById('rawDataResult').innerHTML = 
                        `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function analyzeItems() {
            if (!debugData.rawData) {
                log('‚ùå No raw data. Please run Step 2 first.');
                document.getElementById('analysisResult').innerHTML = 
                    `<div class="error">Please run Step 2 first</div>`;
                return;
            }

            log('üîç Analyzing each item...');
            
            let html = '<div class="warning">Item Analysis:</div>';
            
            debugData.rawData.forEach((item, index) => {
                log(`üìã Item ${index}:`);
                log(`   ID: ${item.id}`);
                log(`   Filename: ${item.filename}`);
                log(`   Original Name: ${item.originalname}`);
                log(`   User: ${item.user}`);
                log(`   Email: ${item.useremail}`);
                log(`   Upload Date: ${item.uploadedat}`);
                log(`   Extra Data: ${item.extradata}`);
                
                html += `
                    <div class="item-card">
                        <strong>Item ${index}</strong><br>
                        ID: ${item.id}<br>
                        Filename: ${item.filename}<br>
                        Original Name: ${item.originalname}<br>
                        User: ${item.user}<br>
                        Email: ${item.useremail}<br>
                        Upload Date: ${item.uploadedat}<br>
                        Extra Data: ${item.extradata || 'None'}
                    </div>
                `;
            });
            
            document.getElementById('analysisResult').innerHTML = html;
            log(`‚úÖ Analyzed ${debugData.rawData.length} items`);
        }

        function testDeduplication() {
            if (!debugData.rawData) {
                log('‚ùå No raw data. Please run Step 2 first.');
                document.getElementById('deduplicationResult').innerHTML = 
                    `<div class="error">Please run Step 2 first</div>`;
                return;
            }

            log('üîç Testing deduplication logic...');
            
            // Test current deduplication logic
            const uniqueData = [];
            const seenFilenames = new Set();
            const duplicates = [];
            
            debugData.rawData.forEach((item, index) => {
                if (!seenFilenames.has(item.filename)) {
                    seenFilenames.add(item.filename);
                    uniqueData.push(item);
                    log(`‚úÖ Added unique: ${item.filename} (ID: ${item.id})`);
                } else {
                    duplicates.push({ ...item, index });
                    log(`‚ùå Found duplicate: ${item.filename} (ID: ${item.id})`);
                }
            });
            
            log(`üìä Deduplication Results:`);
            log(`   Original items: ${debugData.rawData.length}`);
            log(`   Unique items: ${uniqueData.length}`);
            log(`   Duplicates found: ${duplicates.length}`);
            
            let html = `
                <div class="${duplicates.length > 0 ? 'error' : 'success'}">
                    Deduplication Test Results:<br>
                    Original: ${debugData.rawData.length}<br>
                    Unique: ${uniqueData.length}<br>
                    Duplicates: ${duplicates.length}
                </div>
            `;
            
            if (duplicates.length > 0) {
                html += '<div class="warning">Duplicate Items:</div>';
                duplicates.forEach(dup => {
                    html += `
                        <div class="item-card duplicate">
                            <strong>Duplicate Found!</strong><br>
                            ID: ${dup.id}<br>
                            Filename: ${dup.filename}<br>
                            Original Name: ${dup.originalname}<br>
                            Index: ${dup.index}
                        </div>
                    `;
                });
            }
            
            document.getElementById('deduplicationResult').innerHTML = html;
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Debug log cleared...\n';
        }

        // Auto-run session check on page load
        window.addEventListener('load', () => {
            log('üöÄ Shree Upload Analysis loaded');
            checkSession();
        });
    </script>
</body>
</html>
